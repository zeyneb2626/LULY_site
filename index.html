<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Configurateur Tradi'home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- model-viewer (Google) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body { margin:0; padding:1rem; font-family:sans-serif; }
    #app { display:flex; gap:2rem; max-width:1200px; margin:auto; }
    model-viewer { width: 100%; height: 500px; background:#f0f0f0; }
    .controls { width:300px; }
    .group { margin-bottom:2rem; }
    .group h2 { margin:0 0 .5rem; font-size:1.1rem; }
    .opts { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
    .opts button {
      border:1px solid #ccc; padding:.5rem;
      background:#fff; cursor:pointer; text-align:center;
    }
    .opts button.selected { border-color:#00f; }
    #price { font-size:1.3rem; font-weight:600; margin-top:1rem; }
  </style>
</head>
<body>
  <div id="app">
    <!-- 3D VIEW -->
    <model-viewer
      id="model"
      src="Tradi_home2_draco.glb"
      camera-controls
      auto-rotate
      environment-image="neutral"
      exposure="1"
      background-color="#ffffff">
    </model-viewer>

    <!-- CONFIGURATOR -->
    <div class="controls">
      <!-- Bardage -->
      <div class="group" data-cat="bardage">
        <h2>Bardage Extérieur</h2>
        <div class="opts">
          <button data-value="blanc"    data-color="#ffffff" data-cost="0">Blanc<br>+0 €</button>
          <button data-value="chene"    data-color="#deb887" data-cost="520">Chêne clair<br>+520 €</button>
          <button data-value="fonce"    data-color="#8b4513" data-cost="790">Chêne foncé<br>+790 €</button>
          <button data-value="grorage"  data-color="#2f4f4f" data-cost="895">Gris orage<br>+895 €</button>
        </div>
      </div>

      <!-- Menuiserie -->
      <div class="group" data-cat="menuiserie">
        <h2>Menuiserie Alu</h2>
        <div class="opts">
          <button data-value="blanc"       data-color="#ffffff" data-cost="0">Blanc<br>+0 €</button>
          <button data-value="anthracite"  data-color="#333333" data-cost="2499">Anthracite<br>+2499 €</button>
        </div>
      </div>

      <!-- Gouttière -->
      <div class="group" data-cat="gouttiere">
        <h2>Gouttière & Descente</h2>
        <div class="opts">
          <button data-value="blanc"       data-color="#ffffff" data-cost="0">Blanc<br>+0 €</button>
          <button data-value="anthracite"  data-color="#333333" data-cost="350">Anthracite<br>+350 €</button>
        </div>
      </div>

      <!-- Pergola -->
      <div class="group" data-cat="pergola">
        <h2>Pergola Bioclimatique</h2>
        <div class="opts">
          <button data-value="blanc"       data-color="#ffffff" data-cost="0">Blanc<br>+0 €</button>
          <button data-value="anthracite"  data-color="#333333" data-cost="9500">Anthracite<br>+9500 €</button>
        </div>
      </div>

      <!-- Peinture Mur -->
      <div class="group" data-cat="peinture">
        <h2>Peinture Mur Extérieur</h2>
        <div class="opts">
          <button data-value="blanc"       data-color="#ffffff" data-cost="0">Blanc<br>+0 €</button>
          <button data-value="beige"       data-color="#d2b48c" data-cost="999">Beige Arès<br>+999 €</button>
          <button data-value="ocre"        data-color="#e0ac69" data-cost="1499">Ocre Mojave<br>+1499 €</button>
        </div>
      </div>

      <!-- Toiture -->
      <div class="group" data-cat="toiture">
        <h2>Tôle Ondulée</h2>
        <div class="opts">
          <button data-value="bleuar"      data-color="#2f4f4f" data-cost="0">Bleu Ardoise<br>+0 €</button>
          <button data-value="grisacier"   data-color="#a9a9a9" data-cost="0">Gris Acier<br>+0 €</button>
          <button data-value="rouge"       data-color="#c72c48" data-cost="1800">Rouge Hibiscus<br>+1800 €</button>
        </div>
      </div>

      <div id="price">Prix total : 170 000 €</div>
    </div>
  </div>

  <script>
    const basePrice = 170000;
    const model = document.querySelector('#model');
    const priceEl = document.getElementById('price');

    // Matériaux dans le GLB (noms EXACTS)
    const materialMap = {
      bardage:     ['poutrine_01','poutrine_02'],
      menuiserie:  ['cadre_porte_fenetre'],
      gouttiere:   ['goutieres'],
      pergola:     ['poutres','volets_pergola'],
      peinture:    ['murs'],
      toiture:     ['toit1']
    };

    // Stockage des choix et cumul prix
    let selection = {};

    document.querySelectorAll('.group').forEach(group => {
      const cat = group.dataset.cat;
      group.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          // Visuel
          group.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');

          // Sauvegarde
          const color = btn.dataset.color;
          const cost  = parseInt(btn.dataset.cost);
          selection[cat] = cost;

          // Mise à jour matériau(s)
          const mats = materialMap[cat] || [];
          mats.forEach(name => {
            const mat = model.model.materials[name];
            mat.pbrMetallicRoughness.setBaseColorFactor(
              hexToNormalizedRGBA(color)
            );
          });

          // Recalcule prix
          const total = Object.values(selection).reduce((a,b) => a+b, basePrice);
          priceEl.textContent = `Prix total : ${total.toLocaleString()} €`;
        });
      });

      // Sélectionner le 1er bouton par défaut
      const first = group.querySelector('button');
      first.click();
    });

    // Convertit "#rrggbb" → [r,g,b,a]
    function hexToNormalizedRGBA(hex) {
      const v = parseInt(hex.replace('#',''),16);
      const r = (v >> 16 & 0xFF)/255;
      const g = (v >> 8  & 0xFF)/255;
      const b = (v       & 0xFF)/255;
      return [r,g,b,1];
    }
  </script>
</body>
</html>
